<!--
Copyright (c) 2020 The Khronos Group Inc.
Use of this source code is governed by an MIT-style license that can be
found in the LICENSE.txt file.
-->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tests rapidly resizing a 2D-rendered canvas and uploading to WebGL textures</title>
<link rel="stylesheet" href="../../../resources/js-test-style.css"/>
<script src="../../../js/js-test-pre.js"></script>
<script src="../../../js/webgl-test-utils.js"></script>
<script src="../../../js/tests/tex-image-and-sub-image-utils.js"></script>
</head>
<body onload="run()">
<canvas id="c" width="128" height="128"></canvas>
<div id="description"></div>
<div id="console"></div>
<script>
"use strict";
description();
let wtu = WebGLTestUtils;
let tiu = TexImageUtils;
let canvas = document.getElementById("c");
let gl = wtu.create3DContext(canvas);
let program = tiu.setupTexturedQuad(gl, gl.RGBA);
let canvas2d = document.createElement("canvas");
let ctx2d = canvas2d.getContext("2d");

let numTextures = 50;
let textures = new Array(numTextures);
let colors = new Array(numTextures);

let numIterations = 50;

const tolerance = 3;
let failures = 0;

// https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript
function mulberry32(a)
{
    return function()
    {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}

// Use a consistent pseudo-random number generator.
let baseRandom = mulberry32(0xDEADBEEF);

// Returns a random number between 1 and _num_.
function random(num)
{
    let val;
    do {
        val = Math.floor(baseRandom() * num);
    } while (val == 0);
    return val;
}

function output(str)
{
    debug(str);
    bufferedLogToConsole(str);
}

function setupTextures()
{
    for (let i = 0; i < numTextures; ++i) {
        let tex = gl.createTexture();
        // Bind the texture to the default texture unit 0
        gl.bindTexture(gl.TEXTURE_2D, tex);
        // Set up texture parameters
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        textures[i] = tex;
    }
}

function randomColor()
{
    return [ random(255), random(255), random(255) ];
}

function generateRandomTextures()
{
    // Do all of the uploads at once because readbacks drain the
    // graphics pipeline and decrease the chance of provoking
    // synchronization bugs.
    for (let i = 0; i < numTextures; ++i) {
        let color = randomColor();
        canvas2d.width = random(256);
        canvas2d.height = random(256);
        ctx2d.fillStyle = "rgb(" + color[0] + "," + color[1] + "," + color[2] + ",1.0)";
        ctx2d.fillRect(0, 0, canvas2d.width, canvas2d.height);
        gl.bindTexture(gl.TEXTURE_2D, textures[i]);
        // Not sure whether the bug might be in the texImage2D or texSubImage2D code path.
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, canvas2d.width, canvas2d.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, gl.RGBA, gl.UNSIGNED_BYTE, canvas2d);
        //        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas2d);
        colors[i] = color;
    }
}

function checkTextures()
{
    for (let i = 0; i < numTextures; ++i) {
        gl.bindTexture(gl.TEXTURE_2D, textures[i]);
        wtu.clearAndDrawUnitQuad(gl, [0, 0, 0, 255]);
        wtu.checkCanvasRectColor(gl, Math.floor(canvas.width / 2), Math.floor(canvas.height / 2), 1, 1,
                                 colors[i], tolerance, () => {}, (msg) => { testFailed(msg); ++failures; }, () => {});
    }
}

function runOneIteration()
{
    generateRandomTextures();
    checkTextures();
    if (--numIterations > 0) {
        requestAnimationFrame(runOneIteration);
    } else {
        if (failures == 0) {
            testPassed("all comparisons passed");
        }
        finishTest();
    }
}

function run()
{
    setupTextures();
    requestAnimationFrame(runOneIteration);
}

var successfullyParsed = true;
</script>
</body>
</html>
